<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simple Speech Recognition + TTS</title>
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0}
  body{display:flex;flex-direction:column;gap:12px;padding:18px;max-width:880px;margin-inline:auto}
  header{display:flex;align-items:center;gap:12px}
  h1{font-size:1.25rem;margin:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fafafa;cursor:pointer}
  button.active{background:#222;color:#fff}
  .status{padding:6px 10px;border-radius:8px;background:#f1f1f1;border:1px solid #e6e6e6}
  .transcript{min-height:120px;border-radius:8px;padding:12px;border:1px solid #eee;background:#fff;overflow:auto}
  .line{padding:6px 0;border-bottom:1px dashed #f4f4f4}
  label{display:flex;gap:8px;align-items:center}
  select,input[type="text"]{padding:8px;border-radius:8px;border:1px solid #ddd}
  footer{font-size:0.85rem;color:#666;margin-top:8px}
</style>
</head>
<body>
  <header>
    <h1>Speech Recognition + TTS demo</h1>
    <div class="status" id="status">Idle</div>
  </header>

  <div class="controls" aria-hidden="false">
    <button id="micToggle">Turn mic ON</button>
    <button id="stopBtn">Stop</button>
    <button id="clearBtn">Clear</button>
    <label>
      Language:
      <select id="langSelect">
        <option value="en-US">English (US)</option>
        <option value="en-GB">English (GB)</option>
        <option value="hi-IN">Hindi (India)</option>
        <option value="es-ES">Spanish</option>
      </select>
    </label>
  </div>

  <div>
    <strong>Transcript</strong>
    <div class="transcript" id="transcript" aria-live="polite"></div>
  </div>

  <div>
    <label>
      Custom reply:
      <input type="text" id="replyInput" placeholder="Type a reply the speaker will say (optional)" />
    </label>
    <button id="speakBtn">Speak reply</button>
  </div>

  <footer>
    Notes: Uses Web Speech API (SpeechRecognition + speechSynthesis). Best in Chrome. Microphone permission required.
  </footer>

<script>
(() => {
  // Feature detection
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const statusEl = document.getElementById('status');
  const micToggle = document.getElementById('micToggle');
  const stopBtn = document.getElementById('stopBtn');
  const clearBtn = document.getElementById('clearBtn');
  const transcriptEl = document.getElementById('transcript');
  const langSelect = document.getElementById('langSelect');
  const replyInput = document.getElementById('replyInput');
  const speakBtn = document.getElementById('speakBtn');

  if (!SpeechRecognition) {
    statusEl.textContent = 'SpeechRecognition not supported in this browser.';
    micToggle.disabled = true;
    stopBtn.disabled = true;
    speakBtn.disabled = !(!!window.speechSynthesis);
    return;
  }

  // Create recognizer
  const recog = new SpeechRecognition();
  recog.continuous = true;      // keep listening until stopped
  recog.interimResults = true;  // provide interim (in-progress) results
  recog.maxAlternatives = 1;

  let isListening = false;
  let finalTranscript = '';

  function appendLine(text, confidence=null, interim=false) {
    const div = document.createElement('div');
    div.className = 'line';
    div.textContent = (interim ? '[…] ' : '') + text + (confidence !== null ? ` (conf:${(confidence*100).toFixed(0)}%)` : '');
    transcriptEl.prepend(div);
  }

  function updateStatus(txt, cls='') {
    statusEl.textContent = txt;
  }

  // Recognition events
  recog.onstart = () => {
    isListening = true;
    micToggle.classList.add('active');
    micToggle.textContent = 'Turn mic OFF';
    updateStatus('Listening…');
  };

  recog.onerror = (e) => {
    console.warn('Recognition error', e);
    updateStatus('Error: ' + (e.error || 'unknown'));
  };

  recog.onend = () => {
    isListening = false;
    micToggle.classList.remove('active');
    micToggle.textContent = 'Turn mic ON';
    updateStatus('Stopped');
  };

  recog.onresult = (event) => {
    // event.results is a SpeechRecognitionResultList
    let interim = '';
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      const r = event.results[i];
      if (r.isFinal) {
        finalTranscript = r[0].transcript.trim();
        appendLine(finalTranscript, r[0].confidence, false);
        // Simple "AI" response — you can replace with AJAX to your server or local logic
        const userText = finalTranscript;
        // If user typed a custom reply, speak that; else respond with canned response.
        const custom = replyInput.value && replyInput.value.trim();
        const aiReply = custom || `I heard: ${userText}`;
        speakText(aiReply);
      } else {
        interim = r[0].transcript;
        // show interim (replace the top interim element)
        // remove existing interim line(s)
        const existing = transcriptEl.querySelectorAll('.line');
        if (existing.length && existing[0].textContent.startsWith('[…]')) {
          existing[0].remove();
        }
        appendLine(interim, null, true);
      }
    }
  };

  // Controls
  micToggle.addEventListener('click', async () => {
    if (isListening) {
      recog.stop();
      updateStatus('Stopping…');
    } else {
      // set language
      recog.lang = langSelect.value || 'en-US';
      try {
        // requesting mic permission happens automatically when start() runs
        recog.start();
      } catch (err) {
        console.error('Start error:', err);
        updateStatus('Start failed: ' + err.message);
      }
    }
  });

  stopBtn.addEventListener('click', () => {
    try {
      recog.stop();
      updateStatus('Stopping…');
    } catch (e) {
      console.warn(e);
    }
  });

  clearBtn.addEventListener('click', () => {
    transcriptEl.innerHTML = '';
  });

  // Text-to-speech
  function speakText(text) {
    if (!window.speechSynthesis) {
      console.warn('No speechSynthesis available');
      return;
    }
    // cancel any current speaking
    window.speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    // optional: choose voice that matches selected language
    const targetLang = langSelect.value || 'en-US';
    const voices = window.speechSynthesis.getVoices() || [];
    // pick a voice that matches lang if available
    const v = voices.find(voice => voice.lang && voice.lang.startsWith(targetLang.split('-')[0]))
              || voices.find(voice => voice.lang === targetLang)
              || voices[0];
    if (v) utter.voice = v;
    utter.rate = 1;
    utter.pitch = 1;
    utter.onstart = () => updateStatus('Speaking…');
    utter.onend = () => updateStatus(isListening ? 'Listening…' : 'Idle');
    window.speechSynthesis.speak(utter);
  }

  speakBtn.addEventListener('click', () => {
    const text = (replyInput.value && replyInput.value.trim()) || (finalTranscript ? `You said: ${finalTranscript}` : 'Hello! Say something to me.');
    speakText(text);
  });

  // Ensure voices are loaded (some browsers load asynchronously)
  if (window.speechSynthesis && typeof window.speechSynthesis.onvoiceschanged !== 'undefined') {
    window.speechSynthesis.onvoiceschanged = () => {
      // no-op; this ensures voices list is populated for selection
      console.info('voices changed', window.speechSynthesis.getVoices());
    };
  }

  // initial UI
  updateStatus('Idle');
})();
</script>
</body>
</html>
